<!DOCTYPE html>
<html lang="en">
<head>
<style>
/*NOT MY CSS */
input::-webkit-outer-spin-button,
input::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
}

input[type=number]::-webkit-outer-spin-button,
input[type=number]::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
}

input[type=number] {
    -moz-appearance:textfield;
}

.circle {
  border: 1px solid #aaa;
  box-shadow: inset 1px 1px 3px #DDDDDD;
  width: 16px;
  height: 16px;
  border-radius: 100%;
  position: relative;
  margin: 0px;
  margin-left: 2px;
  margin-top: -3px;
  display: inline-block;
  vertical-align: middle;
  background: #DDDDDD;
}

.circle:hover {
  background: #F2F2F2;
}

.circle:active {
  background: #60606080;
}

.circle:before,
.circle:after {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
}

/* PLUS */

.circle.plus:before,
.circle.plus:after {
  background: black;
}

.circle.plus:before {
  margin: 3px auto;
  width: 2px;
}

.circle.plus:after {
  margin: auto 3px;
  height: 2px;
}

#ElementAddedToast {
  visibility: hidden;
  min-width: 460px;
  margin-left: -230px;
  background-color: #339033;
  color: #ffffff;
  text-align: center;
  border-radius: 25px;
  padding-top: 5px;
  padding-bottom: 5px;
  padding-left: 0px;
  padding-right: 0px;
  position: fixed;
  z-index: 1;
  left: 50%;
  bottom: 10px;
  font-size: 18px;
  -webkit-touch-callout: none; /* iOS Safari */
    -webkit-user-select: none; /* Safari */
     -khtml-user-select: none; /* Konqueror HTML */
       -moz-user-select: none; /* Firefox */
        -ms-user-select: none; /* Internet Explorer/Edge */
            user-select: none; /* Non-prefixed version, currently
                                  supported by Chrome and Opera */
}

#NothingToDeleteToast {
  visibility: hidden;
  min-width: 300px;
  margin-left: -150px;
  background-color: #903333;
  color: #ffffff;
  text-align: center;
  border-radius: 25px;
  padding-top: 5px;
  padding-bottom: 5px;
  padding-left: 0px;
  padding-right: 0px;
  position: fixed;
  z-index: 1;
  left: 50%;
  bottom: 10px;
  font-size: 18px;
  -webkit-touch-callout: none; /* iOS Safari */
    -webkit-user-select: none; /* Safari */
     -khtml-user-select: none; /* Konqueror HTML */
       -moz-user-select: none; /* Firefox */
        -ms-user-select: none; /* Internet Explorer/Edge */
            user-select: none; /* Non-prefixed version, currently
                                  supported by Chrome and Opera */
}

#ElementAddedToast.show {
  visibility: visible;
  -webkit-animation: fadein 0.5s, fadeout 0.5s 2.5s;
  animation: fadein 0.5s, fadeout 0.5s 2.5s;
}

#NothingToDeleteToast.show {
  visibility: visible;
  -webkit-animation: fadein 0.5s, fadeout 0.5s 2.5s;
  animation: fadein 0.5s, fadeout 0.5s 2.5s;
}

@-webkit-keyframes fadein {
  from {bottom: 0; opacity: 0;} 
  to {bottom: 10px; opacity: 1;}
}

@keyframes fadein {
  from {bottom: 0; opacity: 0;}
  to {bottom: 10px; opacity: 1;}
}

@-webkit-keyframes fadeout {
  from {bottom: 10px; opacity: 1;} 
  to {bottom: 0; opacity: 0;}
}

@keyframes fadeout {
  from {bottom: 10px; opacity: 1;}
  to {bottom: 0; opacity: 0;}
}


head {
   height: 0px;
   padding: 0px;
   margin: 0px;
}

html {
   height: 100%;
}

body {
  display: flex;
  flex-direction: column;
  margin-top: 0px;
  padding-top: 0px;
  margin-bottom: 0px;
  max-width: 100%;
  height: 100%;
}

.container {
   height: 100%;
   padding: 0px;
   margin: 0px;
}

.topArea {
  width: 100%;
  border-bottom: 2px solid;
  max-height: 136px;
}

.bottomSection {
   /** height: 81%; **/
   height: calc(100vh - 146px);
   padding: 0px;
   margin: 0px;
   border-bottom: 2px solid;
   border-left: 2px solid;
   border-right: 2px solid;
}

.chart {
   float: left;
   width: 50%;
   overflow-y: auto;
   height: 100%;  
}

.jsonArea {
   float: right;
   width: 50%;
   overflow: hidden;
   padding: 0px;
   margin: 0px;
   height: 100.4%;
}

.jsonTextArea {
   width: 99.6%;
   height: 99.4%;
   padding: 0px;
   margin: 0px;
   resize: none;
}

.middleButtons {
}

.swapButton {
   left: 50%;
   width: 28px;
   height: 23px;
   margin-top: -6px;
   margin-left: -14px;
   display: inline;
   position: absolute;
}

.convertToJSONButton {
   left: 50%;
   margin-left: -210px;
   right: auto;
   margin-right: auto;
   margin-top: -6px;
   display: inline;
   position: absolute;
}

.convertToTreeButton {
   right: 50%;
   margin-right: -210px;
   left: auto;
   margin-left: auto;
   margin-top: -6px;
   display: inline;
   position: absolute;
}

.hideJSONButton {
    right: 8px;
    position: absolute;
    display: block;
    margin-top: -23px;
}
</style>

<title>JSON Tree Writer - EBMonFHIR - Blank Evidence Resource</title>
</head>
<body>
<div class="container">
     <div class="topArea">
     <h2 style="margin: 4px;">JSON Tree Writer - EBMonFHIR - Blank Evidence Resource</h2>
     <p style="margin-top: 8px;"><input type="file" id="]....}?|?|?{....[jsonFile" style="width: 500px; border: 1px solid #555555;" accept=".txt, .json, .js, .ts, .tex, .rtf, .odt, .wpd, .text"></p>
	 <button onclick="SaveTreeToJSON()">Save Tree to JSON</button> <button onclick="deleteEmptyFields();">Delete Empty Fields</button> <input onchange="" type="checkbox" id="]....}?|?|?{....[keepFields" name="keepFields" value="keepBlankFields" title="Having this unchecked removes the empty fields from the saved JSON. It also removes empty objects." checked> Keep blank fields when converted to JSON?
	 <br><br>
     <span style="display: inline">
	 <input id="]....}?|?|?{....[treeWriteChecked" type="radio" name="readWriteMode" value="write" onchange="switchReadWrite();" checked="checked"> Write 
	 <input id="]....}?|?|?{....[treeReadChecked" type="radio" name="readWriteMode" value="read" onchange="switchReadWrite();"> Read
     <span class="middleButtons">
     <button class="convertToJSONButton" onclick="convertTreeToJSON()" id="]....}?|?|?{....[convertToJSONButton"><b>Convert Tree to JSON ➡</b></button>
     <button class="convertToTreeButton" onclick="convertJSONToTree()" id="]....}?|?|?{....[convertToTreeButton"><b>⬅ Convert JSON to Tree</b></button>
     <button class="swapButton" onclick="swapSides()" style="" title="Swap the sides of the tree and JSON."><b>⇆</b></button>
     </span>
     </span>
          <button class="hideJSONButton" id="]....}?|?|?{....[hideJSONButton" onclick="hideShowJSON()" style=""><b>Hide JSON View</b></button>
     </div>
     <div class="bottomSection" id="]....}?|?|?{....[bottomSection">
       <div class="chart" id="]....}?|?|?{....[treeChart">
       </div>
       <div class="jsonArea" id="]....}?|?|?{....[jsonArea">
       <textarea class="jsonTextArea" id="]....}?|?|?{....[jsonTextArea" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"></textarea>
       </div>
     </div>
    <div id="ElementAddedToast">A new element has been added to the end of the list.</div>
    <div id="NothingToDeleteToast">No blank elements to delete.</div>
</div>

<!-- Imports lodash only for clearing blank fields -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.4/lodash.min.js"></script>
<script>

if (getCookie("jsonView") == "false"){
   hideShowJSON();
}

if (getCookie("sides") == "TreeRight") {
   swapSides();
}

var indentSize = 20;

//var file = "https://drive.google.com/uc?export=view&id=1F2OY-FKDZyucNaAxzjwN9TF3OWOVFgP3";
var file = "file.png";
//var folder = "https://drive.google.com/uc?export=view&id=1v-_ojUqFOD0o9HStrV6gpyLRn423ErDq";
var folder = "folder.png";
//var closedfolder = "https://drive.google.com/uc?export=view&id=1p1ErqyQqtHQBrqRdfU07qXXaug1EuAGQ";
var closedfolder = "closed-folder-transparent.png";

var json;

//var lodash = false;

var folderCount = 0;

var htmlBlocks = {};
var jsonBlocks = {};

var hashDict = 0;

var acceptableExtensions = [".txt", ".json", ".js", ".ts", ".tex", ".rtf", ".odt", ".wpd", ".text"]

//NOT MY CODE below
function getCookie(cname) {
  var name = cname + "=";
  var ca = document.cookie.split(';');
  for(var i = 0; i < ca.length; i++) {
    var c = ca[i];
    while (c.charAt(0) == ' ') {
      c = c.substring(1);
    }
    if (c.indexOf(name) == 0) {
      return c.substring(name.length, c.length);
    }
  }
  return "";
}

if(window.addEventListener) {
    window.addEventListener('load', buildTree, false); //W3C
} else {
    window.attachEvent('onload', buildTree); //Older IE
}

//Only uses this imported script if they're using Internet Explorer.
if(/MSIE \d|Trident.*rv:/.test(navigator.userAgent)) {
    var bluebirdscript = document.createElement("script");
    bluebirdscript.src = "https://cdnjs.cloudflare.com/ajax/libs/bluebird/3.3.4/bluebird.min.js";
    bluebirdscript.type = "text/javascript";
    document.getElementsByTagName("head")[0].appendChild(bluebirdscript);
}

document.getElementById(']....}?|?|?{....[jsonFile').addEventListener('change', loadJsonFile);

function loadJsonFile(event){
  const input = event.target;
  if ('files' in input && input.files.length > 0) {
	  placeFileContent(input.files[0]);
  }
}

function placeFileContent(file) {
   readFileContent(file).then(function(content) { json = JSON.parse(content); buildTree(); }).catch( function(error) { console.log(error) });
}

function readFileContent(file) {
   const reader = new FileReader();
   return new Promise(function(resolve, reject) { reader.onload = function(event) { resolve(event.target.result) };  reader.onerror = function(error) { reject(error) }; reader.readAsText(file); })
}

function cleanDictionary(el) {
  function internalClean(el) {
    return _.transform(el, function(result, value, key) {
      var isCollection = _.isObject(value);
      var cleaned = isCollection ? internalClean(value) : value;

      if (isCollection && _.isEmpty(cleaned)) {
        return;
      }

      _.isArray(result) ? result.push(cleaned) : (result[key] = cleaned);
    });
  }

  return _.isObject(el) ? internalClean(el) : el;
}

function hashCode(dictString) {
  var hash = 0, i, chr;
  if (dictString.length === 0) return hash;
  for (i = 0; i < dictString.length; i++) {
    chr   = dictString.charCodeAt(i);
    hash  = ((hash << 5) - hash) + chr;
    //hash |= 0; // Convert to 32bit integer
  }
  return hash;
};

window.addEventListener("beforeunload", function (e) {
    if (hashDict != hashCode(JSON.stringify(TreeToJSON()))) {
		var confirmMessage = 'If you leave this page your changes to the form, if any, will be lost.';
		(e || window.event).returnValue = confirmMessage; //Gecko + IE
		return confirmMessage; //Gecko + Webkit, Safari, Chrome etc.
	}
}); 
//END OF NOT MY CODE

function convertTreeToJSON(){
   var jsonToSave = JSON.stringify(TreeToJSON(), null, 2).replace(/"{\[{NeGaTiVe!_!0}]}"/g, "-0").replace(/([^\r])\n/g, "$1\r\n");
   jsonToSave = jsonToSave.replace(/"{\[{NeGaTiVe!_!0pointZERO}]}"/g, "-0.0");
   document.getElementById("]....}?|?|?{....[jsonTextArea").value = jsonToSave;
}
function convertJSONToTree(){
     try {
        var convertingJSON = JSON.parse(document.getElementById("]....}?|?|?{....[jsonTextArea").value);
        json = convertingJSON;
        buildTree();
     } catch(err){
        alert("Invalid JSON formatting");
     }
}

function swapSides() {
   if (document.getElementsByClassName("chart")[0].style.float == "right"){
      document.getElementsByClassName("chart")[0].style.float = "left";
      document.getElementsByClassName("jsonArea")[0].style.float = "right";
      document.getElementById("]....}?|?|?{....[convertToJSONButton").innerHTML = "<b>Convert Tree to JSON ➡</b>";
      document.getElementById("]....}?|?|?{....[convertToJSONButton").style.right = "auto";
      document.getElementById("]....}?|?|?{....[convertToJSONButton").style.marginRight = "auto";
      document.getElementById("]....}?|?|?{....[convertToJSONButton").style.left = "50%";
      document.getElementById("]....}?|?|?{....[convertToJSONButton").style.marginLeft = "-210px";      
      document.getElementById("]....}?|?|?{....[convertToTreeButton").innerHTML = "<b>⬅ Convert JSON to Tree</b>";
      document.getElementById("]....}?|?|?{....[convertToTreeButton").style.left = "auto";
      document.getElementById("]....}?|?|?{....[convertToTreeButton").style.marginLeft = "auto";
      document.getElementById("]....}?|?|?{....[convertToTreeButton").style.right = "50%";
      document.getElementById("]....}?|?|?{....[convertToTreeButton").style.marginRight = "-210px";
      document.cookie = "sides=TreeLeft;";
   } else {
      document.getElementsByClassName("chart")[0].style.float = "right";
      document.getElementsByClassName("jsonArea")[0].style.float = "left";
      document.getElementById("]....}?|?|?{....[convertToJSONButton").innerHTML = "<b>⬅ Convert Tree to JSON</b>";
      document.getElementById("]....}?|?|?{....[convertToJSONButton").style.left = "auto";
      document.getElementById("]....}?|?|?{....[convertToJSONButton").style.marginLeft = "auto";
      document.getElementById("]....}?|?|?{....[convertToJSONButton").style.right = "50%";
      document.getElementById("]....}?|?|?{....[convertToJSONButton").style.marginRight = "-210px";
      document.getElementById("]....}?|?|?{....[convertToTreeButton").innerHTML = "<b>Convert JSON to Tree ➡</b>";
      document.getElementById("]....}?|?|?{....[convertToTreeButton").style.right = "auto";
      document.getElementById("]....}?|?|?{....[convertToTreeButton").style.marginRight = "auto";
      document.getElementById("]....}?|?|?{....[convertToTreeButton").style.left = "50%";
      document.getElementById("]....}?|?|?{....[convertToTreeButton").style.marginLeft = "-210px";
      document.cookie = "sides=TreeRight;";
   }
}

function hideShowJSON(){
   if (document.getElementById("]....}?|?|?{....[jsonArea").style.display != "none"){
      document.getElementById("]....}?|?|?{....[jsonArea").style.display = "none";
      document.getElementById("]....}?|?|?{....[hideJSONButton").innerHTML = "<b>Show JSON View</b>";
      document.getElementById("]....}?|?|?{....[bottomSection").style.height = "auto";
      document.getElementsByClassName("swapButton")[0].style.display = "none";
      document.getElementById("]....}?|?|?{....[convertToJSONButton").style.display = "none";
      document.getElementById("]....}?|?|?{....[convertToTreeButton").style.display = "none";
      document.getElementsByClassName("chart")[0].style.width = "100%";
      document.cookie = "jsonView=false";
   } else {
      document.getElementById("]....}?|?|?{....[jsonArea").style.display = "block";
      document.getElementById("]....}?|?|?{....[hideJSONButton").innerHTML = "<b>Hide JSON View</b>";
      //document.getElementById("]....}?|?|?{....[bottomSection").style.height = "81%";
      document.getElementById("]....}?|?|?{....[bottomSection").style.height = "calc(100vh - 146px)";
      document.getElementsByClassName("swapButton")[0].style.display = "inline";
      document.getElementById("]....}?|?|?{....[convertToJSONButton").style.display = "inline";
      document.getElementById("]....}?|?|?{....[convertToTreeButton").style.display = "inline";
      document.getElementsByClassName("chart")[0].style.width = "50%";
      document.cookie = "jsonView=true";
   }

}

function deleteEmptyFields (){
   var hashBefore = hashCode(JSON.stringify(TreeToJSON()));
   var previousCheck = document.getElementById("]....}?|?|?{....[keepFields").checked;
   document.getElementById("]....}?|?|?{....[keepFields").checked = false;
   var dict = TreeToJSON();
   var hashAfter = hashCode(JSON.stringify(dict));
   if (hashBefore != hashAfter){
      //Warning
      if (confirm('Are you sure you want to delete these empty field(s)')) {
        json = dict;
        buildTree();
      }
   } else {
      toastNothingToDelete();
   }
   
   document.getElementById("]....}?|?|?{....[keepFields").checked = previousCheck;
}

function switchReadWrite(){
    var allInputs = document.getElementsByTagName("input");
	var allButtons = document.getElementsByClassName("addButton");
	var onlyTextBoxes = [];
	for (var i = 0; i < allInputs.length; i++) {
		if((allInputs[i].type.toLowerCase() == 'text' || allInputs[i].type.toLowerCase() == 'number' || allInputs[i].type.toLowerCase() == 'hidden') && (allInputs[i].id.substring(0, 18) != "]....}?|?|?{....[_")) {
			onlyTextBoxes.push(allInputs[i]);
		}
	}
	allInputs = onlyTextBoxes;
	if (document.getElementById("]....}?|?|?{....[treeWriteChecked").checked) {
	   for (var i in allInputs) {
	      allInputs[i].style.display = "inline";
	      allInputs[i].nextSibling.nextSibling.style.display = "none";
	   }
	   for (var j = 0; j < allButtons.length; j++) {
		  allButtons[j].style.display = "inline";
	   }
	} else {
		for (var i in allInputs) {
		  allInputs[i].style.display = "none";
		  allInputs[i].nextSibling.nextSibling.style.display = "inline";
          if (allInputs[i].type.toLowerCase() != 'hidden') {
		     allInputs[i].nextSibling.nextSibling.innerHTML = "(" + allInputs[i].value + ")";
          } else {
             var allListBoxes = document.getElementsByName(allInputs[i].name);
             var allListBoxValues = [];
             for (var z = 0; z < allListBoxes.length; z++){
                if(allListBoxes[z].id  == "]....}?|?|?{....[_" + allInputs[i].name){
                   if (!document.getElementById("]....}?|?|?{....[keepFields").checked && allListBoxes[z].value == "") {
                      //Does nothing
                   } else {
                      allListBoxValues.push(allListBoxes[z].value);
                   }
                }
             }
             allInputs[i].nextSibling.nextSibling.innerHTML = "(" + allListBoxValues.toString() + ")";
          }
		}
	    for (var j = 0; j < allButtons.length; j++) {
		  allButtons[j].style.display = "none";
	    }
	}
}

function SaveTreeToJSON(){

    var saveJSONfile = prompt("Filename for the JSON you're saving", "Resource JSON file.txt");
    
	if (saveJSONfile != null) {
        var dict = TreeToJSON();
        
	    if (saveJSONfile.indexOf(".") == -1 || acceptableExtensions.indexOf(saveJSONfile.substring(saveJSONfile.lastIndexOf("."), saveJSONfile.length)) == -1) {
		   saveJSONfile = saveJSONfile + ".txt";		   
		}
        
        var jsonToSave = JSON.stringify(dict, null, 2).replace(/"{\[{NeGaTiVe!_!0}]}"/g, "-0").replace(/([^\r])\n/g, "$1\r\n");
        jsonToSave = jsonToSave.replace(/"{\[{NeGaTiVe!_!0pointZERO}]}"/g, "-0.0");

        if (navigator.msSaveBlob) { // IE 10+ 
          navigator.msSaveBlob(new Blob([jsonToSave], { type: 'data:text/plain;charset=utf-8;' }), saveJSONfile);
        } else {
          var element = document.createElement('a');
          element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(jsonToSave));
          element.setAttribute('download', saveJSONfile);
          element.style.display = 'none';
          document.body.appendChild(element);
          element.click();
          document.body.removeChild(element);
        }
		hashDict = hashCode(JSON.stringify(dict));
    }
}

function TreeToJSON(){
        var d1 = document.getElementById(']....}?|?|?{....[treeChart');
        
        var current_index = -1;
        
        var allInputs = document.getElementsByTagName("input");
        
        var onlyTextBoxes = [];
        for(var i = 0; i < allInputs.length; i++) {
            if(allInputs[i].type.toLowerCase() == 'text' || allInputs[i].type.toLowerCase() == 'hidden' || allInputs[i].type.toLowerCase() == 'number') {
                onlyTextBoxes.push(allInputs[i]);
            }
        }
        allInputs = onlyTextBoxes;
    
        var dict = {};
    
        for (x in allInputs) {
          var paths = allInputs[x].name.split(".");
          var current_path = "";
          
            for (var y = 0; y < paths.length - 1; y++){
               var previous_path = current_path;
               current_path += "." + paths[y];
               var temp_path = current_path;
               if (paths[y].indexOf("[") > -1) {
                  temp_path = current_path.substring(0, current_path.lastIndexOf("["));
                  temp_previous_path = previous_path.substring(0, previous_path.lastIndexOf("["));
               }
               if (eval("dict"+temp_path)) {
                 array_index = current_path.substring(current_path.lastIndexOf("[")+1, current_path.lastIndexOf("]"));
                 if (eval("dict"+temp_path).length <= parseInt(array_index)) {
                    eval("dict"+temp_path).push({});
                 }
               } else {
                  if (paths[y].indexOf("[") > -1) {
                     eval("dict"+current_path.substring(0, current_path.lastIndexOf("[")) + " = " + "[{}]");
                  } else {
                     eval("dict"+current_path + " = " + "{}")
                  }
               }
            }
          
          
          if (!document.getElementById("]....}?|?|?{....[keepFields").checked && (allInputs[x].value == "" && allInputs[x].type != "hidden")) {
            //DON'T SAVE THE INPUT IF IT IS BLANK and the checkbox is unchecked
          } else if(allInputs[x].id.substring(0, 18) != "]....}?|?|?{....[_") {
            
            var inputValue = allInputs[x].value;
            if (inputValue == "null"){
               eval("dict"+"."+allInputs[x].name + " = " + "null");
            } else if (inputValue.toLowerCase() == "false"){
               eval("dict"+"."+allInputs[x].name + " = " + "false");
               //Automatically converts false and true to a boolean in the JSON, this unfortunately doesn't allow true and false as a string.
            } else if (inputValue.toLowerCase() == "true"){
               eval("dict"+"."+allInputs[x].name + " = " + "true");
            } else if (allInputs[x].type == "hidden") {
               var allListBoxes = document.getElementsByName(allInputs[x].name);
               var allListBoxValues = [];
               for (var z = 0; z < allListBoxes.length; z++){
                  if(allListBoxes[z].id  == "]....}?|?|?{....[_" + allInputs[x].name){
                     if (!document.getElementById("]....}?|?|?{....[keepFields").checked && allListBoxes[z].value == "") {
                        //Does nothing
                     } else {
                     
                     if (allListBoxes[z].type == "number") {
                         var tempValue = allListBoxes[z].value;
                         if (allListBoxes[z].value == ""){
                            tempValue = "'{[{NeGaTiVe!_!0}]}'";
                            //TO DO todo
                            //THIS IS POTENTIALLY VERY BAD, and it may not be valid JSON either.
                            //Would using tempValue = "'{[{NeGaTiVe!_!0pointZERO}]}'" is better? So that it would be -0.0?
                            //I think it would be smarter to save this as
                            //tempValue = "null"
                         } else if (allListBoxes[z].value == "-0") {
                            tempValue = "'{[{NeGaTiVe!_!0}]}'";
                            //This negative 0 is fine because this would be the user explicitly typing in -0;
                         } else if(allListBoxes[z].value == "-0.0"){
                            tempValue = "'{[{NeGaTiVe!_!0pointZERO}]}'";
                            //This negative 0 is fine because this would be the user explicitly typing in -0.0;
                         }
                         allListBoxValues.push(parseFloat(tempValue));
                      } else {
                         var tempValue = allListBoxes[z].value.replace(/'/g, "\\'");
                         allListBoxValues.push(tempValue);
                      }
                        //allListBoxValues.push(allListBoxes[z].value);
                     }
                  }
               }
               
               if (!document.getElementById("]....}?|?|?{....[keepFields").checked && allListBoxValues == []){
                  //Does nothing
               } else {
                  eval("dict"+"."+allInputs[x].name + " = " + JSON.stringify(allListBoxValues));
               }
            } else if (allInputs[x].type == "number") {
               var tempValue = allInputs[x].value;
               if (allInputs[x].value == ""){
                  tempValue = "'{[{NeGaTiVe!_!0}]}'";
                  //TO DO todo
                  //THIS IS POTENTIALLY VERY BAD, and it may not be valid JSON either.
                  //Would using tempValue = "'{[{NeGaTiVe!_!0pointZERO}]}'" is better? So that it would be -0.0?
                  //I think it would be smarter to save this as
                  //tempValue = "null"
               } else if (allInputs[x].value == "-0") {
                  tempValue = "'{[{NeGaTiVe!_!0}]}'";
                  //This negative 0 is fine because this would be the user explicitly typing in -0;
               } else if(allInputs[x].value == "-0.0"){
                  tempValue = "'{[{NeGaTiVe!_!0pointZERO}]}'";
                  //This negative 0 is fine because this would be the user explicitly typing in -0.0;
               }
               eval("dict"+"."+allInputs[x].name + " = " + tempValue);
            } else {
               var tempValue = allInputs[x].value.replace(/'/g, "\\'");
               eval("dict"+"."+allInputs[x].name + " = " + "'" + tempValue + "'");
            }
          }
          
        }
        if (!document.getElementById("]....}?|?|?{....[keepFields").checked) {
           dict = cleanDictionary(dict);
        }
        
        return dict;
}

function toggleHideShow(folderImage, id){
   if (document.getElementById(id).style.display == 'none') {
       folderImage.src = folder;
       document.getElementById(id).style.display = 'block';
   } else {
       folderImage.src = closedfolder;
       document.getElementById(id).style.display = 'none';
   }
}

function elementAdd(elementNumber){
   var fullJsonBlock = {};
   fullJsonBlock[jsonBlocks[elementNumber][3]] =  jsonBlocks[elementNumber][0];
   var htmlBlock = loopDictionary(fullJsonBlock, jsonBlocks[elementNumber][1], jsonBlocks[elementNumber][2]);
   var folder_path = jsonBlocks[elementNumber][2]+jsonBlocks[elementNumber][3].toString();
   
   var num = 1;
   var latestFolder = document.getElementById(folder_path + "[0]").nextSibling;
   while (true) {
      if (document.getElementById(folder_path + "[" + num.toString() + "]")) {
	     latestFolder = document.getElementById(folder_path + "[" + num.toString() + "]").nextSibling;
	  } else {
		 var i = '<p id="' + folder_path + '"';
         i = i.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&');
         var re = new RegExp(i, 'g');
		 htmlBlock = htmlBlock.replace(re, '<p id="' + jsonBlocks[elementNumber][2]+jsonBlocks[elementNumber][3].toString() + '[' + num.toString() + ']' + '"');
		 var i = '<p id="' + folder_path + '.';
         i = i.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&');
         var re = new RegExp(i, 'g');
		 htmlBlock = htmlBlock.replace(re, '<p id="' + jsonBlocks[elementNumber][2]+jsonBlocks[elementNumber][3].toString() + '[' + num.toString() + ']' + '.');
         break;
	  }
	  num += 1;
   }
   
    var i = 'input id="' + jsonBlocks[elementNumber][2]+(jsonBlocks[elementNumber][3]).toString();
    i = i.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&');
    var re = new RegExp(i, 'g');
    htmlBlock = htmlBlock.replace(re, 'input id="' + jsonBlocks[elementNumber][2]+(jsonBlocks[elementNumber][3]).toString()+"["+num+"]");
   
    var i = 'name="' + jsonBlocks[elementNumber][2]+(jsonBlocks[elementNumber][3]).toString();
    i = i.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&');
    var re = new RegExp(i, 'g');
    htmlBlock = htmlBlock.replace(re, 'name="' + jsonBlocks[elementNumber][2]+(jsonBlocks[elementNumber][3]).toString()+"["+num+"]");
   
   //Clear the for the inputs
   htmlBlock = htmlBlock.replace(/value=".*?"/g, 'value=""');
   
   //Then it loops through and finds all the folders inside that block, and replaces the same way in the jsonBlocks
   var tempBlock = htmlBlock;
   while(tempBlock.indexOf("<div id='folder") != -1){
      tempBlock = tempBlock.substring(tempBlock.indexOf("<div id='folder")+15, tempBlock.length);
	  var folderFound = tempBlock.substring(0, tempBlock.indexOf("'"));
      if (jsonBlocks[folderFound]) {
		  var tempReplace = jsonBlocks[folderFound][2]+(jsonBlocks[folderFound][3]).toString();
		  var tempPath = jsonBlocks[elementNumber][2]+(jsonBlocks[elementNumber][3]).toString();
		  var tempExten = jsonBlocks[folderFound][2].substring(tempPath.length, jsonBlocks[folderFound][2].length);
		  jsonBlocks[folderFound][2] = tempPath+"["+num+"]"+tempExten;
	  }
   }
   document.getElementById(latestFolder.id).insertAdjacentHTML("afterend", htmlBlock);
   
   var temp_a = htmlBlock.substring(htmlBlock.indexOf("id='folder")+10, htmlBlock.length);
   var temp_x = temp_a.indexOf("'");
   var temp_b = temp_a.substring(0, temp_x);
   jsonBlocks[elementNumber][4] = temp_b;
   toastElementAdded();
}

function toastElementAdded() {
  var x = document.getElementById("ElementAddedToast");
  x.className = "show";
  setTimeout(function(){ x.className = x.className.replace("show", ""); }, 2990);
}

function toastNothingToDelete() {
  var x = document.getElementById("NothingToDeleteToast");
  x.className = "show";
  setTimeout(function(){ x.className = x.className.replace("show", ""); }, 2990);
}

function loopDictionary(json, indent, current_path){
   var generatedHTML = "";
	for (var key in json) {		
		if (json[key] == null || typeof json[key] != typeof {}){
           var inputType = 'text'
           if (typeof(json[key]) == typeof(1)){
              inputType = 'number' 
           }
           //For the "hidden" input type used for the arrays.
           if (json[key] != null && json[key] === 0 && (1/json[key]) === -Infinity) {
             json[key] = "";
           }
		   generatedHTML += '<p id="' + current_path+key.toString() +'" style="margin-top: 2px; margin-bottom: 2px;'+ ' margin-left: ' + (indent*indentSize).toString() + 'px;' +'"><img src="' + file +'"><b> ' + key.toString() + '</b> <input id="' + current_path + key.toString() + '" name="' + current_path + key.toString() + '" type="' + inputType + '" style="width: 300px;" value="' + json[key] +'"></input> <span style="display: none;">()</span></p>';
		} else {
			if (!Array.isArray(json[key])){
				generatedHTML += '<p id="' + current_path+key.toString() + '" style="margin-top: 2px; margin-bottom: 2px;'+ ' margin-left: ' + (indent*indentSize).toString() + 'px"><img src="' + folder +'" onclick="toggleHideShow(this, \'folder' + folderCount.toString() + '\');"><b> ' + key.toString() + '</b>' + '</p>';
                generatedHTML += "<div id='folder" + folderCount.toString() + "'>";
                folderCount += 1;
				indent += 1;
				if (current_path != "" && current_path[current_path.length - 1] != "."){
				   current_path += ".";
				}
				generatedHTML += loopDictionary(json[key], indent, current_path+key.toString()+".");
				indent -= 1;
                generatedHTML += "</div>";
			} else if (Array.isArray(json[key])){
				if (typeof json[key][0] == typeof {}) {
				    var visibilityButton = "";
					var visibility = 'display: inline;';
					for (var entry in json[key]) {
						var sendDict = { };
						sendDict[key] = json[key][entry];
						var currentFolderCount = folderCount;
						jsonBlocks[folderCount] = [json[key][entry], indent, current_path, key, folderCount.toString()];
						
						generatedHTML += '<p id="' + current_path+key.toString()+ '[' + entry + ']' +'" style="margin-top: 2px; margin-bottom: 2px;'+ ' margin-left: ' + (indent*indentSize).toString() + 'px"><img src="' + folder +'" onclick="toggleHideShow(this, \'folder' + folderCount.toString() + '\');"><b> ' + key + '</b> <span id="buttonAdd' + folderCount.toString() + '" class="addButton' + visibilityButton + '" style="' + visibility + '"><button class="circle plus" onclick="elementAdd(' + folderCount.toString() + ')" title="Add another one of this element."></button></span>' + '</p>';
                        generatedHTML += "<div id='folder" + folderCount.toString() + "'>";
						visibilityButton = "Invisible";
						visibility = 'display: none;'
						var previous_folderCount = folderCount;
                        folderCount += 1;
						indent += 1;
						if (current_path != "" && current_path[current_path.length - 1] != "."){
							current_path += ".";
						}
						var returnedHTML = loopDictionary(json[key][entry], indent, current_path+key.toString()+"[" + entry.toString() + "]" + ".");
						generatedHTML += returnedHTML;
						
						indent -= 1;
                        generatedHTML += "</div>";
                        //break;  //This is added to only allow one instance of a field. This could be replaced with code to have an "Add" button for the field.
					}
				} else {
                    //generatedHTML += '<p style="margin-top: 2px; margin-bottom: 2px;'+ ' margin-left: ' + (indent*indentSize).toString() + 'px;' +'"><img src="' + file +'"><b> ' + key.toString() + '</b> <input type="text" style="width: 300px;" value="' + json[key] +'"></input> <button style="border-radius: 50%;">+</button></p>';
					//There's two ways to do this.
                    var visibilityButton = "";
                    var visibility = 'display: inline;';
					generatedHTML += '<p id="' + current_path+key.toString()+ '[0]' +'" style="margin-top: 2px; margin-bottom: 2px;'+ ' margin-left: ' + (indent*indentSize).toString() + 'px;' +'"><img src="' + file +'"><b> ' + key.toString() + '</b> <input id="' + current_path + key.toString() + '" name="' + current_path + key.toString() + '" type="hidden" style="width: 300px;"></input><span style="display: none;">()</span><span style="display: none;">()</span><span id="buttonAdd' + folderCount.toString() + '" class="addButton' + visibilityButton + '" style="' + visibility + '">';
				    var visibilityButton = "";
					var visibility = 'display: inline;'
                    var latestTextField = "";
                    for (var entry in json[key]){
                        var inputType = 'text'
                        if (typeof(json[key][entry]) == typeof(1)){
                           inputType = 'number' 
                        }
                        //For the "hidden" input type used for the arrays.
                        if (json[key] != null && json[key] === 0 && (1/json[key]) === -Infinity) {
                           json[key] = "";
                        }
                       //TODO to do make sure that the right type is stored in the type field
                       generatedHTML += '<input id="]....}?|?|?{....[_' + current_path + key.toString() + '" name="' + current_path + key.toString() + '" type="' + inputType + '" value="' + json[key][entry] +'" style="width: 40px; margin-left: 3px;"></input>';
                    }
                    //Latest field, without the value, also the ID changed
                    var latestTextField = '<input id=&quot;]....}?|?|?{....[_' + current_path + key.toString() + '&quot; name=&quot;' + current_path + key.toString() + '&quot; type=&quot;' + inputType + '&quot; style=&quot;width: 40px; margin-left: 3px;&quot;></input>';
                    //FIX THIS
                    generatedHTML += '<button class="circle plus" onclick="addToInputList(this, \'' + latestTextField + '\');" title="Add another one of this element."></button></span></p>';
				}
			}
		}
	}
   //latestJSON = TreeToJSON();
   return generatedHTML;
}

function addToInputList(plusButton, textField){
   plusButton.insertAdjacentHTML("beforebegin", textField);
}

function buildTree(){
	folderCount = 0;
    var image1 = new Image();
    var image2 = new Image();
    var image3 = new Image();
    image1.src = file;
    image2.src = folder;
    image3.src = closedfolder;
    
	var generatedHTML = "";
	generatedHTML += "<div id='folder" + folderCount.toString() + "'>";
	folderCount += 1;
    if ("resourceType" in json) {
       generatedHTML += '<p style="margin-top: 2px; margin-bottom: 2px;'+ ' margin-left: ' + (0*indentSize).toString() + '"><img src="' + folder +'"><b> ' + json["resourceType"] + '</b>' + '</p>';
    } else {
       generatedHTML += '<p style="margin-top: 2px; margin-bottom: 2px;'+ ' margin-left: ' + (0*indentSize).toString() + '"><img src="' + folder +'">' + '</p>';
    }
	generatedHTML += loopDictionary(json, 1, "");
	generatedHTML += "</div>";
	var d1 = document.getElementById(']....}?|?|?{....[treeChart');
    
    d1.innerHTML = generatedHTML;
	//var starting_dict = TreeToJSON();
     hashDict = hashCode(JSON.stringify(TreeToJSON()));
     convertTreeToJSON();
    //TreeToJSON();
}

json = {
  "resourceType": "Evidence",
  "identifier": "",
  "title": "",
  "date": "",
  "publisher": "",
  "author": "",
  "exposureBackground": [
    {
      "description": "",
      "population": "",
      "populationSampleSize": {
        "description": "",
        "numberOfStudies": -0,
        "numberOfParticipants": -0
      },
      "exposureVariant": [
        {
          "id": "",
          "description": "",
          "groupByExposure": "",
          "exposureSubsetSampleSize": {
            "description": "",
            "numberOfStudies": -0,
            "numberOfParticipants": -0
          },
          "measuredVariable": [
            {
              "description": "",
              "measuredVariableDefinition": "",
              "univariateStatistic": [
                {
                  "description": "",
                  "synthesisType": "",
                  "studyType": "",
                  "sampleSize": {
                    "description": "",
                    "numberOfStudies": -0,
                    "numberOfParticipants": -0,
                    "knownDataCount": -0,
                    "numeratorCount": -0
                  },
                  "statistic": [
                    {
                      "description": "",
                      "type": {
                        "coding": {
                          "system": "http://build.fhir.org/valueset-risk-estimate-type.html",
                          "code": "",
                          "display": ""
                        }
                      },
                      "quantity": {
                        "value": -0,
                        "comparator": "",
                        "unit": "",
                        "system": "",
                        "code": ""
                      },
                      "precisionEstimate": {
                        "type": {
                          "coding": {
                            "system": "http://build.fhir.org/valueset-precision-estimate-type.html",
                            "code": "",
                            "display": ""
                          }
                        },
                        "level": -0,
                        "from": -0,
                        "to": -0
                      }
                    }
                  ],
                  "certainty": [
                    {
                      "rating": [
                        {
                          "coding": {
                            "system": "",
                            "code": "",
                            "display": ""
                          }
                        }
                      ],
                      "certaintySubcomponent": [
                        {
                          "type": {
                            "coding": {
                              "system": "",
                              "code": "",
                              "display": ""
                            }
                          },
                          "rating": {
                            "coding": {
                              "system": "",
                              "code": "",
                              "display": ""
                            }
                          }
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ],
          "covariantStatistic": [
            {
              "description": "",
              "measuredVariable1": "",
              "measuredVariable2": "",
              "synthesisType": "",
              "studyType": "",
              "sampleSize": {
                "description": "",
                "numberOfStudies": -0,
                "numberOfParticipants": -0
              },
              "statistic": [
                {
                  "description": "",
                  "type": {
                    "coding": {
                      "system": "",
                      "code": "",
                      "display": ""
                    }
                  },
                  "quantity": {
                    "value": -0,
                    "comparator": "",
                    "unit": "",
                    "system": "",
                    "code": ""
                  },
                  "precisionEstimate": {
                    "type": {
                      "coding": {
                      "system": "http://build.fhir.org/valueset-precision-estimate-type.html",
                      "code": "",
                      "display": ""
                      }
                    },
                    "level": -0,
                    "from": -0,
                    "to": -0
                  },
                  "pvalue": {
                    "type": "",
                    "quantity": {
                      "value": "",
                      "comparator": ""
                    },
                    "range": ""
                  }
                }
              ],
              "certainty": [
                {
                  "rating": [
                    {
                      "coding": {
                        "system": "",
                        "code": "",
                        "display": ""
                      }
                    }
                  ],
                  "certaintySubcomponent": [
                    {
                      "type": {
                        "coding": {
                          "system": "",
                          "code": "",
                          "display": ""
                        }
                      },
                      "rating": {
                        "coding": {
                          "system": "",
                          "code": "",
                          "display": ""
                        }
                      }
                    }
                  ]
                }
              ]
            }
          ]
        }
      ],
      "comparativeStatistic": [
        {
          "description": "",
          "exposure": "",
          "exposureAlternative": "",
          "measuredVariable": "",
          "synthesisType": "",
          "studyType": "",
          "sampleSize": {
            "description": "",
            "numberOfStudies": -0,
            "numberOfParticipants": -0
          },
          "statistic": [
            {
              "description": "",
              "type": {
                "coding": {
                  "system": "http://build.fhir.org/valueset-effect-estimate-type.html",
                  "code": "",
                  "display": ""
                }
              },
              "quantity": {
                "value": -0,
                "comparator": "",
                "unit": "",
                "system": "",
                "code": ""
              },
              "precisionEstimate": {
                "type": {
                  "coding": {
                  "system": "http://build.fhir.org/valueset-precision-estimate-type.html",
                  "code": "",
                  "display": ""
                  }
                },
                "level": -0,
                "from": -0,
                "to": -0
              },
              "pvalue": {
                "type": "",
                "quantity": {
                  "value": -0,
                  "comparator": ""
                },
                "range": ""
              }
            }
          ],
          "certainty": [
            {
              "rating": [
                {
                  "coding": {
                    "system": "",
                    "code": "",
                    "display": ""
                  }
                }
              ],
              "certaintySubcomponent": [
                {
                  "type": {
                    "coding": {
                      "system": "",
                      "code": "",
                      "display": ""
                    }
                  },
                  "rating": {
                    "coding": {
                      "system": "",
                      "code": "",
                      "display": ""
                    }
                  }
                }
              ]
            }
          ]
        }
      ]
    }
  ]
};

</script>

</body>
</html>